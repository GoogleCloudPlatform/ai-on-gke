## Description

This module creates a new [VPC network][vpc] with 1 or more subnetworks and
a [Cloud Router][router] for every region with a subnetwork. By default, it will
create:

* A [Cloud NAT][nat] to enable outbound access to the public internet for VMs
  without public IP addresses; VMs with public IP addresses bypass the NAT to
  directly access the public internet
* A firewall rule that enables inbound SSH access from [Identity-Aware
  Proxy][iap]
* A firewall rule that enables all traffic internal to the network

This behavior is optional and can be configured as [described below](#inputs).
This module is based on networking support in the [Cloud Foundation
Toolkit][cft]. We recommend following the [documentation for the network
module][cft-network] and [submodules][cft-network-submodules] for more details.
In particular, the detailed structure of input variables can be found for:

* [var.firewall\_rules](https://github.com/terraform-google-modules/terraform-google-network/tree/v5.1.0/modules/firewall-rules#inputs)
* [var.secondary\_ranges](https://github.com/terraform-google-modules/terraform-google-network/tree/v5.1.0/modules/subnets#inputs)

[vpc]: https://cloud.google.com/vpc
[router]: https://github.com/terraform-google-modules/terraform-google-cloud-router
[nat]: https://github.com/terraform-google-modules/terraform-google-cloud-nat
[iap]: https://cloud.google.com/iap
[cft]: https://cloud.google.com/foundation-toolkit
[cft-network]: https://github.com/terraform-google-modules/terraform-google-network/tree/v5.1.0
[cft-network-submodules]: https://github.com/terraform-google-modules/terraform-google-network/tree/v5.1.0/modules

Additionally, [Google Private Access][gpa] is enabled by default on all
subnetworks unless it is explicitly disabled. This setting ensures that all VMs
can use Google services such as [Cloud Storage][gcs] even if they do not have
public IP addresses or Cloud NAT is disabled.

[gpa]: https://cloud.google.com/vpc/docs/private-google-access
[gcs]: https://cloud.google.com/storage

### Example

This creates a new VPC network named `cluster-net`.

```yaml
  - id: network1
    source: modules/network/vpc
    settings:
      network_name: cluster-net
```

### Deprecation warning

The variables listed below have been deprecated and will be removed in a future
release. Until they are removed,You may continue to use them in Toolkit
blueprints with the same functionality as documented in the [Toolkit 1.0
release][vpc1.0].

* Deprecated variables
  * `var.primary_subnetwork`
  * `var.additional_subnetworks`
  * `var.subnetwork_size`

[vpc1.0]: https://github.com/GoogleCloudPlatform/hpc-toolkit/blob/v1.0.0/modules/network/vpc/README.md

The following variables have been added to support explicit IP ranges for
subnetworks while retaining existing functionality. We advise adopting them even
if not using explicit IP ranges . The Toolkit ***does not support*** mixing
deprecated variables with the new replacements. The new functionality is
described in [more detail below](#subnetworks).

* New variables to adopt
  * `var.subnetworks`
    * A value for this can be generated by merging `var.primary_subnetwork` and
    `var.additional_subnetworks` into a single list
  * `var.default_primary_subnetwork_size`
    * This variable has been renamed for clarity; its value can be directly
    copied from an explicit setting for `var.subnetwork_size`; if your blueprint
    does not have an explicit setting, the default values are the same

### Subnetworks

This module will always provision at least 1 "primary" subnetwork in which most
resources are expected to be provisioned. This primary subnetwork is determined
by

1. The first element of [var.subnetworks](#input_subnetworks) if it is not the
   empty list
2. A default subnetwork automatically calculated from
   * [var.subnetwork_name](#input_subnetwork_name)
   * [var.region](#input_region)
   * [var.network_address_range](#input_network_address_range)
   * [var.default_primary_subnetwork_size](#input_default_primary_subnetwork_size)

If `var.subnetworks` is provided then the primary subnetwork name is taken
explicitly from it and `var.subnetwork_name` is ignored.

`var.subnetworks` behaves identically to the [Cloud Foundation Toolkit subnets
module][cftsubnets] with the lone exception that one can provide ***one*** of
the following settings for each subnetwork:

* `new_bits`
* `subnet_ip`

If each subnetwork defines `subnet_ip` then these are taken to be their explicit
CIDR IP ranges. If each subnetwork defines `new_bits`, then these are taken to
be the size of the CIDR subnetwork (in bits). IP ranges for each subnetwork are
calculated using `var.network_address_range` as the base IP, producing the most
compact set of subnetworks possible.

> **_NOTE:_** we do not presently support the modification of individual subnetworks
> when using this module to provision more than 1 subnetwork using automatically
> calculated IP ranges based upon `new_bits`. Doing so will cause IP ranges to be
> recalculated for each subnetwork. We advise appending new subnetworks to the end
> of `var.subnetworks`.

[cftsubnets]: https://github.com/terraform-google-modules/terraform-google-network/tree/v5.1.0/modules/subnets

### SSH Access

By default a firewall rule is created to allow inbound SSH access from
[Identity-Aware Proxy][iap]. A user must have the `IAP-Secured Tunnel User`
(`roles/iap.tunnelResourceAccessor`) IAM role to be able to SSH over IAP.

To allow regular SSH access from a known IP address you can add the following
`firewall_rules` setting to the `vpc` module:

```yaml
  - id: network1
    source: modules/network/vpc
    settings:
      firewall_rules:
      - name: ssh-my-machine
        direction: INGRESS
        ranges: [<your-ip-address>/32]
        allow:
        - protocol: tcp
          ports: [22]
```

> **Note**: You must populate the above example with the source IP address from
> which you plan to SSH from. You can use a service like
> [whatismyip.com](https://whatismyip.com) to determine your IP address.

## License

<!-- BEGINNING OF PRE-COMMIT-TERRAFORM DOCS HOOK -->
Copyright 2022 Google LLC

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

     http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.

## Requirements

| Name | Version |
|------|---------|
| <a name="requirement_terraform"></a> [terraform](#requirement\_terraform) | >= 0.15.0 |

## Providers

| Name | Version |
|------|---------|
| <a name="provider_terraform"></a> [terraform](#provider\_terraform) | n/a |

## Modules

| Name | Source | Version |
|------|--------|---------|
| <a name="module_cloud_router"></a> [cloud\_router](#module\_cloud\_router) | terraform-google-modules/cloud-router/google | ~> 6.0 |
| <a name="module_nat_ip_addresses"></a> [nat\_ip\_addresses](#module\_nat\_ip\_addresses) | terraform-google-modules/address/google | ~> 4.1 |
| <a name="module_vpc"></a> [vpc](#module\_vpc) | terraform-google-modules/network/google | ~> 10.0 |

## Resources

| Name | Type |
|------|------|
| [terraform_data.cloud_nat_validation](https://registry.terraform.io/providers/hashicorp/terraform/latest/docs/resources/data) | resource |
| [terraform_data.secondary_ranges_validation](https://registry.terraform.io/providers/hashicorp/terraform/latest/docs/resources/data) | resource |

## Inputs

| Name | Description | Type | Default | Required |
|------|-------------|------|---------|:--------:|
| <a name="input_additional_subnetworks"></a> [additional\_subnetworks](#input\_additional\_subnetworks) | DEPRECATED: please see https://goo.gle/hpc-toolkit-vpc-deprecation for migration instructions | `list(map(string))` | `null` | no |
| <a name="input_allowed_ssh_ip_ranges"></a> [allowed\_ssh\_ip\_ranges](#input\_allowed\_ssh\_ip\_ranges) | A list of CIDR IP ranges from which to allow ssh access | `list(string)` | `[]` | no |
| <a name="input_default_primary_subnetwork_size"></a> [default\_primary\_subnetwork\_size](#input\_default\_primary\_subnetwork\_size) | The size, in CIDR bits, of the default primary subnetwork unless explicitly defined in var.subnetworks | `number` | `15` | no |
| <a name="input_delete_default_internet_gateway_routes"></a> [delete\_default\_internet\_gateway\_routes](#input\_delete\_default\_internet\_gateway\_routes) | If set, ensure that all routes within the network specified whose names begin with 'default-route' and with a next hop of 'default-internet-gateway' are deleted | `bool` | `false` | no |
| <a name="input_deployment_name"></a> [deployment\_name](#input\_deployment\_name) | The name of the current deployment | `string` | n/a | yes |
| <a name="input_enable_cloud_nat"></a> [enable\_cloud\_nat](#input\_enable\_cloud\_nat) | Enable the creation of Cloud NATs. | `bool` | `true` | no |
| <a name="input_enable_cloud_router"></a> [enable\_cloud\_router](#input\_enable\_cloud\_router) | Enable the creation of a Cloud Router for your VPC. For more information on Cloud Routers see https://cloud.google.com/network-connectivity/docs/router/concepts/overview | `bool` | `true` | no |
| <a name="input_enable_iap_rdp_ingress"></a> [enable\_iap\_rdp\_ingress](#input\_enable\_iap\_rdp\_ingress) | Enable a firewall rule to allow Windows Remote Desktop Protocol access using IAP tunnels | `bool` | `false` | no |
| <a name="input_enable_iap_ssh_ingress"></a> [enable\_iap\_ssh\_ingress](#input\_enable\_iap\_ssh\_ingress) | Enable a firewall rule to allow SSH access using IAP tunnels | `bool` | `true` | no |
| <a name="input_enable_iap_winrm_ingress"></a> [enable\_iap\_winrm\_ingress](#input\_enable\_iap\_winrm\_ingress) | Enable a firewall rule to allow Windows Remote Management (WinRM) access using IAP tunnels | `bool` | `false` | no |
| <a name="input_enable_internal_traffic"></a> [enable\_internal\_traffic](#input\_enable\_internal\_traffic) | Enable a firewall rule to allow all internal TCP, UDP, and ICMP traffic within the network | `bool` | `true` | no |
| <a name="input_extra_iap_ports"></a> [extra\_iap\_ports](#input\_extra\_iap\_ports) | A list of TCP ports for which to create firewall rules that enable IAP for TCP forwarding (use dedicated enable\_iap variables for standard ports) | `list(string)` | `[]` | no |
| <a name="input_firewall_log_config"></a> [firewall\_log\_config](#input\_firewall\_log\_config) | Firewall log configuration for Toolkit firewall rules (var.enable\_iap\_ssh\_ingress and others) | `string` | `"DISABLE_LOGGING"` | no |
| <a name="input_firewall_rules"></a> [firewall\_rules](#input\_firewall\_rules) | List of firewall rules | `any` | `[]` | no |
| <a name="input_ips_per_nat"></a> [ips\_per\_nat](#input\_ips\_per\_nat) | The number of IP addresses to allocate for each regional Cloud NAT (set to 0 to disable NAT) | `number` | `2` | no |
| <a name="input_labels"></a> [labels](#input\_labels) | Labels to add to network resources that support labels. Key-value pairs of strings. | `map(string)` | `{}` | no |
| <a name="input_mtu"></a> [mtu](#input\_mtu) | The network MTU (default: 8896). Recommended values: 0 (use Compute Engine default), 1460 (default outside HPC environments), 1500 (Internet default), or 8896 (for Jumbo packets). Allowed are all values in the range 1300 to 8896, inclusively. | `number` | `8896` | no |
| <a name="input_network_address_range"></a> [network\_address\_range](#input\_network\_address\_range) | IP address range (CIDR) for global network | `string` | `"10.0.0.0/9"` | no |
| <a name="input_network_description"></a> [network\_description](#input\_network\_description) | An optional description of this resource (changes will trigger resource destroy/create) | `string` | `""` | no |
| <a name="input_network_name"></a> [network\_name](#input\_network\_name) | The name of the network to be created (if unsupplied, will default to "{deployment\_name}-net") | `string` | `null` | no |
| <a name="input_network_profile"></a> [network\_profile](#input\_network\_profile) | A full or partial URL of the network profile to apply to this network.<br/>This field can be set only at resource creation time. For example, the<br/>following are valid URLs:<br/>- https://www.googleapis.com/compute/beta/projects/{projectId}/global/networkProfiles/{network_profile_name}<br/>- projects/{projectId}/global/networkProfiles/{network\_profile\_name}} | `string` | `null` | no |
| <a name="input_network_routing_mode"></a> [network\_routing\_mode](#input\_network\_routing\_mode) | The network routing mode (default "GLOBAL") | `string` | `"GLOBAL"` | no |
| <a name="input_primary_subnetwork"></a> [primary\_subnetwork](#input\_primary\_subnetwork) | DEPRECATED: please see https://goo.gle/hpc-toolkit-vpc-deprecation for migration instructions | `map(string)` | `null` | no |
| <a name="input_project_id"></a> [project\_id](#input\_project\_id) | Project in which the HPC deployment will be created | `string` | n/a | yes |
| <a name="input_region"></a> [region](#input\_region) | The default region for Cloud resources | `string` | n/a | yes |
| <a name="input_secondary_ranges"></a> [secondary\_ranges](#input\_secondary\_ranges) | "Secondary ranges associated with the subnets.<br/>This will be deprecated in favour of secondary\_ranges\_list at a later date.<br/>Please migrate to using the same." | `map(list(object({ range_name = string, ip_cidr_range = string })))` | `{}` | no |
| <a name="input_secondary_ranges_list"></a> [secondary\_ranges\_list](#input\_secondary\_ranges\_list) | List of secondary ranges associated with the subnets. | <pre>list(object({<br/>    subnetwork_name = string,<br/>    ranges = list(object({<br/>      range_name    = string,<br/>      ip_cidr_range = string<br/>    }))<br/>  }))</pre> | `[]` | no |
| <a name="input_shared_vpc_host"></a> [shared\_vpc\_host](#input\_shared\_vpc\_host) | Makes this project a Shared VPC host if 'true' (default 'false') | `bool` | `false` | no |
| <a name="input_subnetwork_name"></a> [subnetwork\_name](#input\_subnetwork\_name) | The name of the network to be created (if unsupplied, will default to "{deployment\_name}-primary-subnet") | `string` | `null` | no |
| <a name="input_subnetwork_size"></a> [subnetwork\_size](#input\_subnetwork\_size) | DEPRECATED: please see https://goo.gle/hpc-toolkit-vpc-deprecation for migration instructions | `number` | `null` | no |
| <a name="input_subnetworks"></a> [subnetworks](#input\_subnetworks) | List of subnetworks to create within the VPC. If left empty, it will be<br/>replaced by a single, default subnetwork constructed from other parameters<br/>(e.g. var.region). In all cases, the first subnetwork in the list is identified<br/>by outputs as a "primary" subnetwork.<br/><br/>subnet\_name           (string, required, name of subnet)<br/>subnet\_region         (string, required, region of subnet)<br/>subnet\_ip             (string, mutually exclusive with new\_bits, CIDR-formatted IP range for subnetwork)<br/>new\_bits              (number, mutually exclusive with subnet\_ip, CIDR bits used to calculate subnetwork range)<br/>subnet\_private\_access (bool, optional, Enable Private Access on subnetwork)<br/>subnet\_flow\_logs      (map(string), optional, Configure Flow Logs see terraform-google-network module)<br/>description           (string, optional, Description of Network)<br/>purpose               (string, optional, related to Load Balancing)<br/>role                  (string, optional, related to Load Balancing) | `list(map(string))` | `[]` | no |

## Outputs

| Name | Description |
|------|-------------|
| <a name="output_nat_ips"></a> [nat\_ips](#output\_nat\_ips) | External IPs of the Cloud NAT from which outbound internet traffic will arrive (empty list if no NAT is used) |
| <a name="output_network_id"></a> [network\_id](#output\_network\_id) | ID of the new VPC network |
| <a name="output_network_name"></a> [network\_name](#output\_network\_name) | Name of the new VPC network |
| <a name="output_network_self_link"></a> [network\_self\_link](#output\_network\_self\_link) | Self link of the new VPC network |
| <a name="output_subnetwork"></a> [subnetwork](#output\_subnetwork) | Primary subnetwork object |
| <a name="output_subnetwork_address"></a> [subnetwork\_address](#output\_subnetwork\_address) | IP address range of the primary subnetwork |
| <a name="output_subnetwork_name"></a> [subnetwork\_name](#output\_subnetwork\_name) | Name of the primary subnetwork |
| <a name="output_subnetwork_self_link"></a> [subnetwork\_self\_link](#output\_subnetwork\_self\_link) | Self link of the primary subnetwork |
| <a name="output_subnetworks"></a> [subnetworks](#output\_subnetworks) | Full list of subnetwork objects belonging to the new VPC network |
<!-- END OF PRE-COMMIT-TERRAFORM DOCS HOOK -->
