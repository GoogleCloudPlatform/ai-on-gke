steps:
  - id: 'tf validate platform'
    name: 'hashicorp/terraform:1.0.0'
    script:
      terraform init 
      terraform validate
    dir: 'ray-on-gke/platform/'
    waitFor: ['-']

  - id: 'tf apply platform'
    name: 'hashicorp/terraform:1.0.0'
    env: 
      - "TF_IN_AUTOMATION=TRUE"
    script: 
      terraform apply \
      -var=project_id=$PROJECT_ID \
      -var=cluster_name=cluster-$SHORT_SHA-$_PR_NUMBER \
      -var=region=us-central1-c
      || terraform destroy && exit 1
    dir: 'ray-on-gke/platform/'
    waitFor: ['tf validate platform']

  - id: 'get kube config'
    name: 'gcr.io/cloudbuilders/gcloud'
    entrypoint: 'sh'
    args: 
    - '-c'
    - |
      gcloud container clusters get-credentials cluster-$SHORT_SHA-$_PR_NUMBER --location us-central1-c --project $PROJECT_ID
    waitFor: ['tf apply platform']

  - id: 'tf validate user'
    name: 'hashicorp/terraform:1.0.0'
    script:
      terraform init
      terraform validate 
    dir: 'ray-on-gke/user/'
    waitFor: ['-']

  - id: 'tf apply user'
    name: 'hashicorp/terraform:1.0.0'
    env:
      - "USER_NAME=github"
    script: 
      terraform apply \
      -var=project_id=$PROJECT_ID \
      -var=namespace=${USER_NAME}
      -var=service_account=${USER_NAME}-system-account
      || terraform destroy && exit 1
    dir: 'ray-on-gke/platform/'
    waitFor: ['get kube config']

  - id: 'tf destroy'
    name: 'hashicorp/terraform:1.0.0'
    env: 
      - "TF_IN_AUTOMATION=TRUE"
    script: 
      cd ray-on-gke/user 
      terraform destroy 
      cd ray-on-gke/platform
      terraform destroy
    waitFor: ['tf apply user']

