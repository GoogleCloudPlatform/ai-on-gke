# Overridable throughput thresholds
{{$INFERENCE_WORKLOAD_SCALED_UP_SIZE := .CL2_INFERENCE_WORKLOAD_SCALED_UP_SIZE}}
{{$INFERENCE_WORKLOAD_INITIAL_SIZE := .CL2_INFERENCE_WORKLOAD_INITIAL_SIZE}}
{{$TRAINING_WORKLOAD_SINGLE_WORKLOAD_SIZE := .CL2_TRAINING_WORKLOAD_SINGLE_WORKLOAD_SIZE}}
{{$TRAINING_WORKLOAD_MIXED_WORKLOAD_SIZE := .CL2_TRAINING_WORKLOAD_MIXED_WORKLOAD_SIZE}}

{{$DEFAULT_QPS := DefaultParam .CL2_DEFAULT_QPS 100}}
{{$NUM_NAMESPACES := 1}}

name: load
namespace:
  number: {{$NUM_NAMESPACES}}
  deleteStaleNamespaces: true # for experiments
tuningSets:
- name: default
  globalQPSLoad:
    qps: {{$DEFAULT_QPS}}
    burst: 1
- name: Sequence
  parallelismLimitedLoad:
    parallelismLimit: 1

steps:
- module:
    path: modules/measurements.yaml
    params:
      action: start

- name: Creating headless service
  phases:
  # this must be in all namespaces where the statefulset is created
  - namespaceRange:
      min: {{$NUM_NAMESPACES}}
      max: {{$NUM_NAMESPACES}}
    replicasPerNamespace: 1
    tuningSet: Sequence
    objectBundle:
    - basename: headless-service
      objectTemplatePath: headless-service.yaml

- name: Creating low PriorityClass for training workload
  phases:
  - replicasPerNamespace: 1
    tuningSet: Sequence
    objectBundle:
      - basename: priorityclass-low
        objectTemplatePath: priorityclass.yaml
        templateFillMap:
          Value: 1000000

- name: Creating high PriorityClass for inference workload
  phases:
  - replicasPerNamespace: 1
    tuningSet: Sequence
    objectBundle:
      - basename: priorityclass-high
        objectTemplatePath: priorityclass.yaml
        templateFillMap:
          Value: 2000000

- module:
    path: modules/statefulsets.yaml
    params:
      minNamespace: {{$NUM_NAMESPACES}}
      maxNamespace: {{$NUM_NAMESPACES}}
      priorityClassLow: priorityclass-low-0 # Name is autogenerated, hence the -0 prefix.
      priorityClassHigh: priorityclass-high-0 # Name is autogenerated, hence the -0 prefix.
      trainingWorkloadName: training-workload-statefulset
      inferenceWorkloadName: inference-workload-statefulset
      inferenceWorkloadScaledUpSize: {{$INFERENCE_WORKLOAD_SCALED_UP_SIZE}}
      inferenceWorkloadInitialSize: {{$INFERENCE_WORKLOAD_INITIAL_SIZE}}
      trainingWorkloadSingleWorkloadSize: {{$TRAINING_WORKLOAD_SINGLE_WORKLOAD_SIZE}}
      trainingWorkloadMixedWorkloadSize: {{$TRAINING_WORKLOAD_MIXED_WORKLOAD_SIZE}}



- module:
    path: modules/measurements.yaml
    params:
      action: gather
